"use strict";var Live2dModel=function(e,o){function t(e,o,t){var a=new PIXI.loaders.Loader;for(var n in e)/\.moc3$/gi.test(e[n])?a.add(n,e[n],{xhrType:PIXI.loaders.Resource.XHR_RESPONSE_TYPE.BUFFER}):/\.json$/gi.test(e[n])?a.add(n,e[n],{xhrType:PIXI.loaders.Resource.XHR_RESPONSE_TYPE.JSON}):a.add(n,e[n]);for(var n in o)a.add(n,o[n].json,{xhrType:PIXI.loaders.Resource.XHR_RESPONSE_TYPE.JSON}),o[n].voice&&(o[n].voicePlaying=!1,o[n].voiceReady=!1);a.load(function(e,o){t(o)})}function a(e){var o=LIVE2DCUBISMCORE.Moc.fromArrayBuffer(e.moc.data),t=(new LIVE2DCUBISMPIXI.ModelBuilder).setMoc(o).setTimeScale(1).addTexture(0,e.texture00.texture).addTexture(1,e.texture01.texture).addTexture(2,e.texture02.texture).addAnimatorLayer("IDEL",LIVE2DCUBISMFRAMEWORK.BuiltinAnimationBlenders.ADD,1).addAnimatorLayer("Motion",LIVE2DCUBISMFRAMEWORK.BuiltinAnimationBlenders.ADD,1).addAnimatorLayer("Drag",LIVE2DCUBISMFRAMEWORK.BuiltinAnimationBlenders.ADD,1).build();return{model:t,resources:e}}function n(e,o){t(e,o,function(e){var t=a(e);t.montions=o;var n=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(e[o[0].name].data);t.emptyAnimation=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(e.emptymotion.data),t.model.animator.getLayer("IDEL").play(n),u&&(c.stage.removeChild(u.model),c.stage.removeChild(u.model.masks)),u=t,c.stage.addChild(u.model),c.stage.addChild(u.model.masks),v(),g(u)})}function i(o){c=new PIXI.Application(o.app.width,o.app.height,{transparent:!0}),o.container.appendChild(c.view),m=o,t(o.model,o.montions,function(t){u=a(t),u.montions=o.montions;var n=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(u.resources.idle.data);u.emptyAnimation=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(u.resources.emptymotion.data),u.model.animator.getLayer("IDEL").play(n),c.stage.addChild(u.model),c.stage.addChild(u.model.masks),p=new y,g(u),c.ticker.add(function(e){u.model.update(e),u.model.masks.update(c.renderer),u.model.animator.getLayer("Motion")&&u.model.animator.getLayer("Motion").isPlaying&&u.model.animator.getLayer("Motion").currentTime>u.model.animator.getLayer("Motion").currentAnimation.duration&&(l=!1,u.model.animator.getLayer("Motion").stop(),u.montions[s].onEnd()),u.model.animator.getLayer("Motion")&&u.model.animator.getLayer("Motion").isPlaying?(u.montions[s].voiceReady&&!u.montions[s].voicePlaying&&u.model.animator.getLayer("Motion").currentTime>1.5&&(AudioPixel.play(),u.montions[s].voicePlaying=!0),u.model.animator.getLayer("Drag").stop()):u.updateParameter&&u.updateParameter(),m.onUpdate&&m.onUpdate()}),v(),e.onresize=v})}function r(){if(!l){var e=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(u.resources[s].data);e.loop=!1,l=!0,u.montions[s].voice&&AudioPixel.importAudio({url:u.montions[s].voice,onFinish:function(){u.montions[s].voiceReady=!0,u.montions[s].voicePlaying=!1}}),u.model.animator.getLayer("Motion").play(e),u.montions[s].onStart()}}function d(){u.model.animator.getLayer("Motion")&&u.model.animator.getLayer("Motion").isPlaying&&(u.model.animator.getLayer("Motion").stop(),u.montions[s].voicePlaying&&(AudioPixel.pause(),u.montions[s].voiceReady=!0,u.montions[s].voicePlaying=!1),u.montions[s].onEnd(),l=!1)}var m,s="speak",l=!1,u=null,c=null,p=null,v=function(o){void 0===o&&(o=null);var t=m.app.width*e.devicePixelRatio,a=m.app.height*e.devicePixelRatio;c.view.style.width=m.width+"px",c.view.style.height=m.height+"px",c.renderer.resize(t,a),u&&(u.model.position=new PIXI.Point(.5*t+30,.8*a),u.model.scale=new PIXI.Point(1.2*t,1.2*t),u.model.masks.resize(c.view.width,c.view.height))},y=function(){this.pos_x=0,this.pos_y=0;var e=this,t=function(t){if(u)if(u.model.animator.getLayer("Motion").isPlaying)e.pos_x=0,e.pos_y=0;else{var a=c.screen.height/2,n=c.screen.width/2,i=o.documentElement.clientWidth-n-t.clientX,r=o.documentElement.clientHeight-a-t.clientY;e.pos_x=-i/(o.documentElement.clientWidth-n),e.pos_y=-r/(o.documentElement.clientHeight-a)}},a=m.mouseActionEle||c.view;m.mouseActionEle?(a.addEventListener("mousemove",t,!0),a.addEventListener("mouseout",function(){console.log("out")},!1)):c.view.addEventListener("mousemove",t,!1)},g=function(){var e=u.model,o=e.parameters.ids.indexOf("PARAM_ANGLE_X");0>o&&(o=e.parameters.ids.indexOf("ParamAngleX"));var t=e.parameters.ids.indexOf("PARAM_ANGLE_Y");0>t&&(t=e.parameters.ids.indexOf("ParamAngleY"));var a=e.parameters.ids.indexOf("PARAM_BODY_ANGLE_X");0>a&&(a=e.parameters.ids.indexOf("ParamBodyAngleX"));var n=e.parameters.ids.indexOf("PARAM_EYE_BALL_X");0>n&&(n=e.parameters.ids.indexOf("ParamEyeBallX"));var i=e.parameters.ids.indexOf("PARAM_EYE_BALL_Y");0>i&&(i=e.parameters.ids.indexOf("ParamEyeBallY")),u.updateParameter=function(){u.emptyAnimation.evaluate=function(e,r,d,m){o>=0&&(m.parameters.values[o]=d(m.parameters.values[o],30*p.pos_x,0,r)),t>=0&&(m.parameters.values[t]=d(m.parameters.values[t],30*-p.pos_y,0,r)),a>=0&&(m.parameters.values[a]=d(m.parameters.values[a],10*p.pos_x,0,r)),n>=0&&(m.parameters.values[n]=d(m.parameters.values[n],.5*p.pos_x,0,r)),i>=0&&(m.parameters.values[i]=d(m.parameters.values[i],.5*-p.pos_y,0,r))},e.animator.getLayer("Drag")&&e.animator.getLayer("Drag").play(u.emptyAnimation)}};return{createView:i,model:function(){return u},changeMotion:function(e){activeEventIndex=e},changeModel:n,playMontion:function(e){"undefined"!=typeof e&&(activeEventIndex=e),r()},stopMontion:d}}(window,document,void 0);